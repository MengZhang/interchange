function urlObject(e){"use strict";var a,t,n,d,r,o,i,_,c={},s=document.createElement("a"),l={url:window.location.href,unescape:!0,convert_num:!0};if("object"!=typeof e)e=l;else for(t in l)l.hasOwnProperty(t)&&void 0===e[t]&&(e[t]=l[t]);if(s.href=e.url,_=s.search.substring(1),a=_.split("&"),a[0].length>1)for(n=0;n<a.length;n+=1)r=a[n].split("="),e.unescape?(o=decodeURI(r[0]),i=decodeURI(r[1])):(o=r[0],i=r[1]),o=o.toLowerCase(),e.convert_num&&(i.match(/^\d+$/)?i=parseInt(i,10):i.match(/^\d+\.\d+$/)&&(i=parseFloat(i))),void 0===c[o]?c[o]=i:"string"==typeof c[o]?c[o]=[c[o],i]:c[o].push(i),r=[];return d={protocol:s.protocol,hostname:s.hostname,host:s.host,port:s.port,hash:s.hash.substr(1),pathname:s.pathname,search:s.search,parameters:c}}function make_default_when_undefined(e,a){return"undefined"==typeof e?a:e}function findIndex(e,a){for(var t=0;t<a.length;t++)if(e===a[t].eid)return t;return-1}function showHideCurrentDataTable(){if(current_data.length>0){$("#current_data").show(),$("#clear_current_data").show(),$("#current_data_number").show(),$("#current_data_number").text(current_data.length+" search results");var e=$("a[data-target='#current_data_container']");e.hasClass("collapsed")&&(e.removeClass("collapsed"),$("#current_data_container").collapse("toggle")),$("html, body").animate({scrollTop:$("#current_data_container").offset().top},1500)}else document.getElementById("select_all_current_data").checked=!1}function showHideSavedDataTable(){if(saved_data.length>0){$("#saved_data").show(),$(".saved_data_button").show();var e=$("a[data-target='#saved_data_container']");e.hasClass("collapsed")&&(e.removeClass("collapsed"),$("#saved_data_container").collapse("toggle")),$("#saved_data_number").show(),$("#saved_data_number").text(saved_data.length+" selected")}else $("#saved_data").hide(),$(".saved_data_button").hide(),$("#saved_data_number").hide(),document.getElementById("select_all_current_data").checked=!1}function generate_current_data_row(e,a){return row=["<tr class='cdr' id='s_",e.eid,"' ><td>","<input ",a," type='checkbox' class='check' onclick='sclicked(event)'>","</td><td>",e.crid,"</td><td>",e.exname,"</td><td>",e.fl_loc_1,"</td><td>",e.fl_loc_2,"</td><td>",e.institution,"</td><td>",e.cul_name,"</td><td>",e.pdate,"</td><td>",e.api,"</td>"],"AgTrials"==e.api&&row.splice(3,3),row.join("")}function generate_saved_data_row(e){return row=["<tr id='r_",e.eid,"'><td><span class='glyphicon glyphicon-remove' onclick='rclicked(event)' ></span></td><td>",,e.crid,"</td><td>",e.exname,"</td><td>",e.fl_loc_1,"</td><td>",e.fl_loc_2,"</td><td>",e.institution,"</td><td>",e.cul_name,"</td><td>",e.pdate,"</td><td>",e.api,"</td>"].join(""),row}function build_current_data_table(){content=[];for(var e=0;e<current_data.length;e++)-1===findIndex(current_data[e].eid,saved_data)?checked_attribute="":checked_attribute="checked=true",row=generate_current_data_row(current_data[e],checked_attribute),content[e+1]=row;document.getElementById("current_data_body").innerHTML=content.join("")}function select_all_current_data(){checkboxes=document.getElementsByClassName("check"),content=[];for(var e=0;e<checkboxes.length;e++)checkboxes[e].checked=!0,-1===findIndex(current_data[e].eid,saved_data)&&(row=generate_saved_data_row(current_data[e]),content[e+1]=row,saved_data.push(current_data[e]));current_saved_data_body_text=document.getElementById("saved_data_body").innerHTML,new_saved_data_body_text=[content.join(""),current_saved_data_body_text].join(""),document.getElementById("saved_data_body").innerHTML=new_saved_data_body_text}function deselect_all_current_data(){current_data_rows=document.getElementsByClassName("cdr");for(var e=0;e<current_data_rows.length;e++)eid=current_data_rows[e].id.slice(2),checkbox=current_data_rows[e].childNodes[0].childNodes[0],void 0!=checkbox&&(checkbox.checked=!1),saved_data_index=findIndex(eid,saved_data),-1!==saved_data_index&&(saved_data.splice(saved_data_index,1),document.getElementById(["r_",eid].join("")).remove())}function user_clicked_checked_all(){this.checked===!0?select_all_current_data():deselect_all_current_data(),showHideSavedDataTable()}function select(e){saved_data_index=findIndex(e,saved_data),-1===saved_data_index&&(current_data_index=findIndex(e,current_data),data=current_data[current_data_index],saved_data.push(data),row=generate_saved_data_row(data),current_saved_data_body_text=document.getElementById("saved_data_body").innerHTML,new_saved_data_body_text=[row,current_saved_data_body_text].join(""),document.getElementById("saved_data_body").innerHTML=new_saved_data_body_text)}function deselect(e){saved_data_index=findIndex(e,saved_data),-1!==saved_data_index&&(saved_data.splice(saved_data_index,1),document.getElementById(["r_",e].join("")).remove())}function sclicked(e){document.getElementById("select_all_current_data").checked=!1,eid=e.target.parentNode.parentNode.id.slice(2),e.target.checked===!0?select(eid):deselect(eid),showHideSavedDataTable()}function rclicked(e){element_id=e.target.parentNode.parentNode.id,eid=element_id.slice(2),saved_data_index=findIndex(eid,saved_data),saved_data.splice(saved_data_index,1),document.getElementById(element_id).remove(),document.getElementById(["s_",eid].join("")).childNodes[0].childNodes[0].checked=!1,showHideSavedDataTable()}function clear_current_data(){$("#clear_current_data").css("display","none"),$("#current_data_number").hide(),$("#current_data").hide(),current_data=[],showHideCurrentDataTable()}function clear_saved_data(){saved_data=[],deselect_all_current_data(),showHideSavedDataTable()}function build_current_data(e){var a,t,n,d,r,o,i,_,c,s,l,u="N/A";current_data=[];for(var p=0;p<e.length;p++)a=make_default_when_undefined(e[p].dsid,u),t=make_default_when_undefined(e[p].eid,u),n=make_default_when_undefined(e[p].crid,u),d=make_default_when_undefined(e[p].pdate,u),r=make_default_when_undefined(e[p].institution,u),o=make_default_when_undefined(e[p].fl_loc_1,u),i=make_default_when_undefined(e[p].fl_loc_2,u),_=make_default_when_undefined(e[p].exname,u),s=make_default_when_undefined(e[p].api_source,"AgMIP"),c=make_default_when_undefined(e[p].cul_name,u),l=-1===findIndex(t,saved_data)?!1:!0,l=!0,current_data.push({dsid:a,eid:t,crid:n,pdate:d.substr(0,4)+"-"+d.substr(4,2)+"-"+d.substr(6,2),fl_loc_2:i,institution:r,fl_loc_1:o,exname:_,api:s,cul_name:c,checked:l});showHideCurrentDataTable(),build_current_data_table(current_data)}function extractEids(e){var a=[];for(i=0;i<e.length;i++){var t=!1,n=e[i].eid,d=e[i].dsid;for(j=0;j<a.length;j++)if(a[j].dsid==d&&-1==a[j].eids.indexOf(n)){a[j].eids.push(n),t=!0;break}if(!t){var r=[];r.push(n);var o={dsid:d,eids:r};a.push(o)}}return a}function enable_disable_download_button(){var e=!1;$(".db_type_filter").each(function(a,t){return $(t).prop("checked")?($("#download_data").prop("disabled",!1),$("#galaxy_data").prop("disabled",!1),e=!0,!1):void 0}),e===!1&&($("#download_data").prop("disabled",!0),$("#galaxy_data").prop("disabled",!0))}function getParameterByName(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var a=new RegExp("[\\?&]"+e+"=([^&#]*)"),t=a.exec(location.search);return null==t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function obtain_initial_map_population(){$("#spinner").modal("show"),options={type:"GET",url:api_url+"/cache/location",cache:!0,dataType:"json"},$.ajax(options).done(function(e){place_markers_and_clusters_on_map(e)}).fail(function(e,a){$("#error_message").text("Error: Failed To Populate Map: "+a),$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide")})}function obtain_specific_crop_map_population(e){$("#spinner").modal("show"),options={type:"GET",url:api_url+"/cache/location"+("none"==e?"":"?crid="+e),cache:!0,dataType:"json"},$.ajax(options).done(function(e){place_markers_and_clusters_on_map(e)}).fail(function(){$("#error_message").text("Error: Search Operation Has Failed"),$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide")})}function stripNulls(e){return null!=e}function retrieve_data(e,a){$("#spinner").modal("show");var t={};t.locations=a.filter(stripNulls),"none"!=e&&(t.crid=e),t=JSON.stringify(t),options={type:"POST",url:api_url+"/query/geohash",data:t,dataType:"json",contentType:"application/json"},$.ajax(options).done(function(e){build_current_data(e)}).fail(function(){$("#error_message").text("Error: Failed to Obtain Data"),$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide"),document.getElementById("select_all_current_data").checked=!1})}function retrieve_database(e,a){var t=0;-1!=e.indexOf("ACE")&&(t|=1),-1!=e.indexOf("DOME")&&(t|=2),-1!=e.indexOf("ACMO")&&(t|=4);var n={},d=a,r=urlObject(window.location),o=!1;$("#spinner").modal("show"),r.parameters.hasOwnProperty("galaxy_url")&&void 0!=r.parameters.galaxy_url&&(n.galaxy_url=decodeURIComponent(r.parameters.galaxy_url),o=!0),r.parameters.hasOwnProperty("tool_id")&&(n.tool_id=r.parameters.tool_id),n.downloads=d,n.type=t,options={type:"POST",url:api_url+"/download",data:JSON.stringify(n),dataType:"json",contentType:"application/json"},$.ajax(options).done(function(e){if(o){var a=decodeURIComponent(r.parameters.galaxy_url)+"?tool_id="+r.parameters.tool_id+"&URL="+e.url+"&URL_method=get";window.top.location.href=a}else $("#map").trigger("prompt_user_for_download",e)}).fail(function(){$("#error_message").text("Error: Failed to Download Database"),$("#alertModal").modal("show")}).always(function(){$("#spinner").modal("hide")})}function render_map_initially(){var e="https://services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",a="Sources: National Geographic, Esri, DeLorme, HERE, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, iPC",t=L.tileLayer(e,{attribution:a,subdomains:"1234"}),n=L.map("map",{maxZoom:13,minZoom:2,maxBounds:[[-90,-180],[90,180]]}).setView([15,0],1);return t.addTo(n),n.on("zoomend",function(){map.closePopup()}),n}function raise_marker_popup(e,a,t,n,d){n.setLatLng(e).openOn(d).setContent("<b style='color:#bb382b;'>Geohash Point</b> <br><button type='button' data-geohashes='"+JSON.stringify([a])+"' data-eid_count='"+t+"'class='btn btn-primary borRad obtain_data_from_cluster_or_marker' >Obtain Data</button> <br>has "+t+" experiments")}function create_markers_for_map(e){var a=L.popup({offset:L.point(0,-32)});geojsonLayer=L.geoJson(e,{pointToLayer:function(e,t){return L.marker(t,{geohash:e.properties.geohash,count:e.properties.count}).on("contextmenu",function(e){raise_marker_popup(e.latlng,this.options.geohash,this.options.count,a,map)})}}),markerLayer&&map.removeLayer(markerLayer)}function raise_cluster_popup(e,a,t,n,d){n.setLatLng(e).openOn(d).setContent("<b class='blueTxt'>Cluster of Geohashes</b><br><button type='button' data-geohashes='"+JSON.stringify(a)+"' data-eid_count='"+t+"' class='btn btn-primary borRad obtain_data_from_cluster_or_marker'>Obtain Data</button> <br> has "+t+" experiments")}function create_clusters_for_map(){markerLayer=new L.MarkerClusterGroup,markerLayer.addLayer(geojsonLayer);var e=L.popup({offset:L.point(0,-10)});markerLayer.on("clustercontextmenu",function(a){for(var t=a.layer.getAllChildMarkers(),n=[],d=0,r=0;r<t.length;r++)n.push(t[r].options.geohash),d+=parseFloat(t[r].options.count);raise_cluster_popup(a.latlng,n,d,e,map)})}function place_markers_and_clusters_on_map(e){create_markers_for_map(e),create_clusters_for_map(),map.addLayer(markerLayer)}current_data=[],saved_data=[],document.getElementById("clear_current_data").addEventListener("click",clear_current_data,!1),document.getElementById("select_all_current_data").addEventListener("click",user_clicked_checked_all,!1),document.getElementById("clear_saved_data").addEventListener("click",clear_saved_data,!1),$("#obtain_data").click(function(){var e=$("#crop_filter").val(),a=[],t=map.getBounds(),n=0;markerLayer.eachLayer(function(e){t.contains(e.getLatLng())&&(a.push(e.options.geohash),n+=parseFloat(e.options.count))}),retrieve_data(e,a,n)}),$("#map").on("click",".obtain_data_from_cluster_or_marker",function(){var e=$(this).data("geohashes"),a=$(this).data("eid_count"),t=$("#crop_filter").val();map.closePopup(),retrieve_data(t,e,a)}),$("#map").on("place_markers_and_clusters_on_map",function(e,a){a.location_data.length>0&&(markers=[],place_markers_and_clusters_on_map(a.location_data))}),$("#map").on("build_current_data",function(e,a){build_current_data(a.data)}),$("#map").on("prompt_user_for_download",function(e,a){window.open(a.url,"","width=200,height=100")}),$("#apply_filter").click(function(e){e.preventDefault(),map.closePopup();var a=$("#crop_filter").val();obtain_specific_crop_map_population(a)}),$("#download_data").click(function(){if(saved_data.length>0){var e=[],a=$(".db_type_filter"),t=[];$(a).each(function(t){$(a[t]).prop("checked")&&e.push($(a[t]).val())}),t=extractEids(saved_data),retrieve_database(e,t)}}),$(".db_type_filter").click(function(){enable_disable_download_button()}),$("#raise_up_download_modal").click(function(){$(".db_type_filter").each(function(e,a){$(a).prop("checked",!1),$("#download_data").prop("disabled",!0),$("#galaxy_data").prop("disabled",!0)})}),$(".modal").on("show.bs.modal",function(){$("body").css("overflow-y","hidden"),$(this).css("overflow-y","hidden")}),$(".modal").on("hide.bs.modal",function(){$("body").css("overflow-y","auto"),$(this).css("overflow-y","auto")});var api_url=$("#cropsitedb-page").data("url"),map=render_map_initially(),markerLayer,geojsonLayer,markers=[],saved_data=[],current_data=[];obtain_initial_map_population();
